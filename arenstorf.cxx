#include <iostream>
#include<cmath>
using namespace std;
void function(double* f,double* x,const double my);
int main(){
const double my=0.012277471;
double x[4],x4[4],x5[4];
double k1[4],k2[4],k3[4],k4[4],k5[4],k6[4],k7[4],h[4];
double f[4];
double dt=0.1,t=0;
double epsilon=pow(10,-5);
double Temp[4];
double T=10; //tend
x[0]=0.0994;
x[1]=0;
x[2]=0; //y(0)
x[3]=-2.00158510637908;//y'(0)
cout << 0<<"\t"<< x[0]<<"\t"<<x[1]<<"\t"<<x[2]<<"\t"<<x[3]<< endl;
const double Tol=1e-5;
int i=1;
while(t<T){
  i++;
  t+=dt;
function(k1,x,my);
Temp[0]=dt*(0.5*k1[0]);
Temp[1]=dt*(0.5*k1[1]);
Temp[2]=dt*(0.5*k1[2]);
Temp[3]=dt*(0.5*k1[3]);
function(k2,Temp,my);
Temp[0]=dt*(3./40*k1[0]+9./40*k2[0]);
Temp[1]=dt*(3./40*k1[1]+9./40*k2[1]);
Temp[2]=dt*(3./40*k1[2]+9./40*k2[2]);
Temp[3]=dt*(3./40*k1[3]+9./40*k2[3]);
function(k3,Temp,my);
Temp[0]=dt*(44./45*k1[0]-56./15*k2[0]+32./9*k3[0]);
Temp[1]=dt*(44./45*k1[1]-56./15*k2[1]+32./9*k3[1]);
Temp[2]=dt*(44./45*k1[2]-56./15*k2[2]+32./9*k3[2]);
Temp[3]=dt*(44./45*k1[3]-56./15*k2[3]+32./9*k3[3]);
function(k4,Temp,my);
Temp[0]=dt*(19372./8561*k1[0]-25360./2187*k2[0]+64448./6561*k3[0]-212./729*k4[0]);
Temp[1]=dt*(19372./8561*k1[1]-25360./2187*k2[1]+64448./6561*k3[1]-212./729*k4[1]);
Temp[2]=dt*(19372./8561*k1[2]-25360./2187*k2[2]+64448./6561*k3[2]-212./729*k4[2]);
Temp[3]=dt*(19372./8561*k1[3]-25360./2187*k2[3]+64448./6561*k3[3]-212./729*k4[3]);
function(k5,Temp,my);
Temp[0]=dt*(9017./3168*k1[0]-355./33*k2[0]+46732./5247*k3[0]+49./176*k4[0]-5103./18656*k5[0]);
Temp[1]=dt*(9017./3168*k1[1]-355./33*k2[1]+46732./5247*k3[1]+49./176*k4[1]-5103./18656*k5[1]);
Temp[2]=dt*(9017./3168*k1[2]-355./33*k2[2]+46732./5247*k3[2]+49./176*k4[2]-5103./18656*k5[2]);
Temp[3]=dt*(9017./3168*k1[3]-355./33*k2[3]+46732./5247*k3[3]+49./176*k4[3]-5103./18656*k5[3]);
function(k6,Temp,my);
Temp[0]=dt*(35./384*k1[0]+500./1113*k3[0]+125./192*k4[0]-2187./6784*k5[0]+11./84*k6[0]);
Temp[1]=dt*(35./384*k1[1]+500./1113*k3[1]+125./192*k4[1]-2187./6784*k5[1]+11./84*k6[1]);
Temp[2]=dt*(35./384*k1[2]+500./1113*k3[2]+125./192*k4[2]-2187./6784*k5[2]+11./84*k6[2]);
Temp[3]=dt*(35./384*k1[3]+500./1113*k3[3]+125./192*k4[3]-2187./6784*k5[3]+11./84*k6[3]);
function(k7,Temp,my);

x5[0]=x[0]+dt*(35./384*k1[0]+500./1113*k3[0]+125./192*k4[0]-2187./6784*k5[0]+11./84*k6[0]);
x5[1]=x[1]+dt*(35./384*k1[1]+500./1113*k3[1]+125./192*k4[1]-2187./6784*k5[1]+11./84*k6[1]);
x5[2]=x[2]+dt*(35./384*k1[2]+500./1113*k3[2]+125./192*k4[2]-2187./6784*k5[2]+11./84*k6[2]);
x5[3]=x[3]+dt*(35./384*k1[3]+500./1113*k3[3]+125./192*k4[3]-2187./6784*k5[3]+11./84*k6[3]);
x4[0]=x[0]+dt*(5179./57600*k1[0]+7571./16695*k3[0]+393./640*k4[0]-92097./339200*k5[0]+187./2100*k6[0]+1./40*k7[0]);
x4[1]=x[1]+dt*(5179./57600*k1[1]+7571./16695*k3[1]+393./640*k4[1]-92097./339200*k5[1]+187./2100*k6[1]+1./40*k7[1]);
x4[2]=x[2]+dt*(5179./57600*k1[2]+7571./16695*k3[2]+393./640*k4[2]-92097./339200*k5[2]+187./2100*k6[2]+1./40*k7[2]);
x4[3]=x[3]+dt*(5179./57600*k1[3]+7571./16695*k3[3]+393./640*k4[3]-92097./339200*k5[3]+187./2100*k6[3]+1./40*k7[3]);


h[0]=abs(x4[0]-x5[0]);
h[1]=abs(x4[1]-x5[1]);
h[2]=abs(x4[2]-x5[2]);
h[3]=abs(x4[3]-x5[3]);
double max=h[0];
for(int j=1; j<4; j++){
if(h[j]>max)
  max=h[j];
else continue;
}
double H=epsilon/max;
dt=dt*pow(H,0.2)*0.8;//0.2=1/p+1=1/5

for(int k=0;k<4;k++){
x[k]=x4[k]; 
}
cout << t <<"\t"<< x[0]<<"\t"<<x[1]<<"\t"<<x[2]<<"\t"<<x[3]<< endl;



}
  
  
return 0;  
}

void function(double* f,double* x,const double my){
  double r=sqrt(pow(x[0]+my,2)+x[2]*x[2]);
  double s=sqrt(pow(x[0]-1+my,2)+x[2]*x[2]);
  f[0]=x[1];//x'
  f[1]=x[0]+2*x[3]-(1-my)*(x[0]+my)/(r*r*r)-my*(x[0]-1+my)/(s*s*s);//x''
  f[2]=x[3]; //x'
  f[3]=x[2]-2*x[1]-(1-my)*x[2]/(r*r*r)-my*x[2]/(s*s*s); //x''
}